<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Model Switcher</title>
    <style>
      :root {
        --bg: #0f172a;
        --card: #111827;
        --line: #334155;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --ok: #22c55e;
        --warn: #f59e0b;
        --bad: #ef4444;
        --accent: #3b82f6;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        padding: 24px;
        background: radial-gradient(circle at top, #1e293b 0%, var(--bg) 65%);
        color: var(--text);
        font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
      }
      .wrap {
        max-width: 880px;
        margin: 0 auto;
      }
      .card {
        background: color-mix(in srgb, var(--card) 92%, black 8%);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 18px;
        margin-bottom: 16px;
      }
      h1 { margin: 0 0 8px; font-size: 24px; }
      p { margin: 6px 0; color: var(--muted); }
      label { display: block; margin-bottom: 8px; color: var(--muted); }
      input, select, button {
        width: 100%;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid var(--line);
        background: #0b1220;
        color: var(--text);
      }
      button {
        margin-top: 10px;
        cursor: pointer;
        background: linear-gradient(90deg, #2563eb, #1d4ed8);
        border: none;
        font-weight: 600;
      }
      button:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }
      .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .status { font-weight: 600; }
      .ok { color: var(--ok); }
      .warn { color: var(--warn); }
      .bad { color: var(--bad); }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
        font-size: 13px;
        color: #cbd5e1;
      }
      .list {
        margin-top: 10px;
        border-top: 1px solid var(--line);
        padding-top: 10px;
      }
      .item {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        padding: 7px 0;
        border-bottom: 1px solid color-mix(in srgb, var(--line) 55%, transparent 45%);
      }
      @media (max-width: 700px) {
        .row { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>Model Switcher</h1>
        <p>Cambio secuencial para una sola GPU. Mantiene Open WebUI arriba y conmuta inferencia + LiteLLM.</p>
      </div>

      <div class="card">
        <div class="row">
          <div>
            <label for="token">Admin token (Bearer)</label>
            <input id="token" type="password" placeholder="MODEL_SWITCHER_ADMIN_TOKEN" />
          </div>
          <div>
            <label for="target">Modelo destino</label>
            <select id="target"></select>
          </div>
        </div>
        <button id="refresh">Refrescar catálogo</button>
        <button id="switch">Cambiar modelo (downtime inferencia)</button>
      </div>

      <div class="card">
        <p id="current" class="status"></p>
        <p id="degraded" class="status"></p>
        <p id="job" class="status"></p>
        <p id="message" class="mono"></p>
        <div id="models" class="list"></div>
      </div>
    </div>

    <script>
      const tokenInput = document.getElementById('token');
      const targetSelect = document.getElementById('target');
      const refreshBtn = document.getElementById('refresh');
      const switchBtn = document.getElementById('switch');
      const currentEl = document.getElementById('current');
      const degradedEl = document.getElementById('degraded');
      const jobEl = document.getElementById('job');
      const messageEl = document.getElementById('message');
      const modelsEl = document.getElementById('models');

      let activeJobId = null;

      const savedToken = localStorage.getItem('modelSwitcherToken');
      if (savedToken) tokenInput.value = savedToken;

      tokenInput.addEventListener('change', () => {
        localStorage.setItem('modelSwitcherToken', tokenInput.value.trim());
      });

      function authHeaders() {
        const token = tokenInput.value.trim();
        if (!token) throw new Error('Introduce el admin token');
        return {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        };
      }

      function setMessage(text, klass = 'mono') {
        messageEl.className = klass;
        messageEl.textContent = text;
      }

      function renderModels(models, currentModel) {
        targetSelect.innerHTML = '';
        modelsEl.innerHTML = '';

        for (const model of models) {
          const option = document.createElement('option');
          option.value = model.id;
          option.textContent = `${model.id} - ${model.display_name}`;
          targetSelect.appendChild(option);

          const row = document.createElement('div');
          row.className = 'item';
          const left = document.createElement('span');
          left.textContent = `${model.id} (${model.profile})`;
          const right = document.createElement('span');
          right.className = model.healthy ? 'ok' : 'warn';
          right.textContent = model.healthy ? 'healthy' : 'not healthy';
          row.appendChild(left);
          row.appendChild(right);
          modelsEl.appendChild(row);
        }

        if (currentModel) {
          targetSelect.value = currentModel;
        }
      }

      async function loadModels() {
        try {
          const res = await fetch('/ops/api/models', { headers: authHeaders() });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || 'No se pudo cargar catálogo');

          currentEl.className = 'status ok';
          currentEl.textContent = `Modelo activo: ${data.current_model || 'ninguno'}`;
          degradedEl.className = data.degraded ? 'status bad' : 'status ok';
          degradedEl.textContent = data.degraded
            ? `Estado degradado: ${data.reconcile_message || 'revisar estado'}`
            : 'Estado consistente';

          if (data.switch_in_progress) {
            jobEl.className = 'status warn';
            jobEl.textContent = 'Switch en progreso';
          } else {
            jobEl.className = 'status ok';
            jobEl.textContent = 'Sin jobs activos';
          }

          renderModels(data.models || [], data.current_model);
          setMessage('Catálogo actualizado.');
        } catch (err) {
          setMessage(String(err), 'status bad');
        }
      }

      async function pollJob(jobId) {
        activeJobId = jobId;
        switchBtn.disabled = true;
        refreshBtn.disabled = true;

        while (activeJobId) {
          try {
            const res = await fetch(`/ops/api/jobs/${jobId}`, { headers: authHeaders() });
            const data = await res.json();
            if (!res.ok) throw new Error(data.detail || 'Error consultando job');

            jobEl.className = data.status === 'failed' ? 'status bad' : 'status warn';
            jobEl.textContent = `Job ${data.id}: ${data.status} (${data.step})`;

            const latest = (data.steps || [])[data.steps.length - 1];
            if (latest) setMessage(`${latest.at} - ${latest.step}: ${latest.message}`);

            if (['success', 'failed', 'rolled_back'].includes(data.status)) {
              activeJobId = null;
              switchBtn.disabled = false;
              refreshBtn.disabled = false;
              await loadModels();
              return;
            }
          } catch (err) {
            setMessage(String(err), 'status bad');
            activeJobId = null;
            switchBtn.disabled = false;
            refreshBtn.disabled = false;
            return;
          }

          await new Promise((resolve) => setTimeout(resolve, 3000));
        }
      }

      async function startSwitch() {
        try {
          const target = targetSelect.value;
          if (!target) throw new Error('Selecciona un modelo destino');

          const confirmed = window.confirm(
            'Esto detendrá inferencia y LiteLLM temporalmente para cambiar de modelo. ¿Continuar?'
          );
          if (!confirmed) return;

          const res = await fetch('/ops/api/switch', {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify({ target_model: target })
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || 'No se pudo iniciar el switch');

          jobEl.className = 'status warn';
          jobEl.textContent = `Job ${data.job_id}: accepted`;
          setMessage('Switch aceptado. Ejecutando...');
          await pollJob(data.job_id);
        } catch (err) {
          setMessage(String(err), 'status bad');
        }
      }

      refreshBtn.addEventListener('click', loadModels);
      switchBtn.addEventListener('click', startSwitch);
      loadModels();
    </script>
  </body>
</html>
